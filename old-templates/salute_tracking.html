<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salute Tracking</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        .layout {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            flex: 0 0 40%;
            background-color: #f4f4f4;
            border-right: 1px solid #ddd;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .sidebar h2 {
            margin-top: 0;
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
        }

        .user-table th,
        .user-table td {
            padding: 8px;
            text-align: left;
        }

        .user-table th {
            font-weight: bold;
        }

        .select-btn {
            padding: 6px 12px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            background-color: #007BFF;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .select-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .main {
            flex: 0 0 60%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .btn {
            display: block;
            width: 200px;
            padding: 15px;
            margin: 10px 0;
            font-size: 18px;
            text-align: center;
            color: #fff;
            background-color: #007BFF;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s, transform 0.3s;
            cursor: pointer;
        }

        .btn.stop {
            background-color: #dc3545;
        }

        .btn.result {
            background-color: #ffc107;
            color: #000;
        }

        .btn-custom {
            background-color: #4CAF50;
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .btn:hover:not(:disabled),
        .select-btn:hover:not(:disabled) {
            opacity: 0.9;
        }

        @media (max-width: 600px) {
            .layout {
                flex-direction: column;
            }

            .sidebar,
            .main {
                flex: none;
                width: 100%;
                height: auto;
            }

            .sidebar {
                border-right: none;
                border-bottom: 1px solid #ddd;
            }
        }
    </style>
</head>

<body>
    <div class="layout">
        <div class="sidebar">
            <h2>Active Users</h2>
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>User ID</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="userList">
                    <!-- Rows inserted here -->
                </tbody>
            </table>
        </div>
        <div class="main">
            <h1>Salute Control Panel</h1>
            <button id="startBtn" class="btn start btn-custom" onclick="startTracking()" disabled>Start
                Tracking</button>
            <button id="stopBtn" class="btn stop" onclick="stopTracking()" disabled>Stop Tracking</button>
            <a id="viewResultLink" href="#"><button id="resultBtn" class="btn result" disabled>View Result</button></a>
            <a id="downloadLink" href="#" download><button id="downloadBtn" class="btn" disabled>ðŸ“¥ Download
                    PDF</button></a>
        </div>
    </div>

    <script>
        let selectedUserId = null;
        let prevButton = null;

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const resultBtn = document.getElementById('resultBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const viewResultLink = document.getElementById('viewResultLink');
        const downloadLink = document.getElementById('downloadLink');
        const userList = document.getElementById('userList');

        function updateControls() {
            const enabled = !!selectedUserId;
            startBtn.disabled = !enabled;
            stopBtn.disabled = !enabled;
            resultBtn.disabled = !enabled;
            downloadBtn.disabled = !enabled;
            if (enabled) {
                viewResultLink.href = `/result/${selectedUserId}`;
                downloadLink.href = `/download-pdf/results/${selectedUserId}`;
            }
        }

        function selectUser(userId, btn) {
            if (prevButton) prevButton.disabled = false;
            selectedUserId = userId;
            btn.disabled = true;
            prevButton = btn;
            updateControls();
        }

        function startTracking() {
            if (!selectedUserId) return;
            fetch(`/start_tracking/salute/${selectedUserId}`)
                .then(response => response.json())
                .then(data => alert(data.status))
                .finally(() => {
                    window.location.href = `/salute/analysis`;
                });
        }

        function stopTracking() {
            if (!selectedUserId) return;
            fetch(`/stop_tracking/salute`)
                .then(response => response.json())
                .then(data => alert(data.status));
        }

        window.addEventListener('DOMContentLoaded', () => {
            fetch('/sessions/active')
                .then(response => response.json())
                .then(data => {
                    data.forEach(session => {
                        const row = document.createElement('tr');
                        const nameCell = document.createElement('td');
                        nameCell.textContent = `${session.first_name} ${session.last_name}`;
                        const idCell = document.createElement('td');
                        idCell.textContent = session.user_id;
                        const actionCell = document.createElement('td');
                        const btn = document.createElement('button');
                        btn.className = 'select-btn';
                        btn.textContent = 'Select';
                        btn.onclick = () => selectUser(session.user_id, btn);
                        actionCell.appendChild(btn);
                        row.appendChild(nameCell);
                        row.appendChild(idCell);
                        row.appendChild(actionCell);
                        userList.appendChild(row);
                    });
                })
                .catch(err => console.error('Failed to load active users', err));
        });
    </script>
</body>

</html>